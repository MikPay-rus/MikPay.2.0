<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MikPay 2.0 ‚Äî –¶–µ–Ω—Ç—Ä –ø–æ–∫—É–ø–æ–∫ –∏ –æ–ø–ª–∞—Ç</title>
  <style>
    :root{
      --bg1:#4e6cff; --bg2:#6fc1ff;
      --card:#ffffff; --text:#0f172a; --muted:#64748b;
      --line:#e5e7eb; --pri:#4e6cff; --bad:#ef4444; --ok:#22c55e;
      --sh:0 18px 50px rgba(0,0,0,.20);
      --r:18px;
      --toast:rgba(15,23,42,.92);
    }
    body.dark{
      --bg1:#0b1220; --bg2:#111827;
      --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8;
      --line:#1f2937; --pri:#5b7cfa;
      --sh:0 18px 60px rgba(0,0,0,.45);
      --toast:rgba(255,255,255,.12);
    }
    *{ box-sizing:border-box; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif }
    body{
      margin:0; min-height:100vh; color:var(--text);
      display:flex; align-items:center; justify-content:center;
      padding:18px;
      background:
        radial-gradient(900px 500px at 10% 10%, rgba(255,255,255,.35), transparent 60%),
        radial-gradient(700px 420px at 90% 20%, rgba(255,255,255,.25), transparent 55%),
        linear-gradient(135deg,var(--bg1),var(--bg2));
    }

    .app{
      width:min(1040px,100%);
      background:rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.22);
      border-radius:calc(var(--r) + 12px);
      padding:14px;
      backdrop-filter: blur(10px);
    }
    .panel{
      position:relative;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--sh);
      overflow:hidden;
    }
    header{
      display:flex; justify-content:space-between; align-items:center;
      padding:14px; border-bottom:1px solid var(--line);
      gap:12px;
    }
    .brand{display:flex; gap:10px; align-items:center; user-select:none}
    .logo{
      width:36px;height:36px;border-radius:14px;
      background:linear-gradient(135deg,var(--pri),#9ab2ff);
      box-shadow:0 14px 26px rgba(78,108,255,.35);
    }
    .titles{display:flex; flex-direction:column; line-height:1.1}
    .titles b{font-size:15px; letter-spacing:.2px}
    .titles small{color:var(--muted); font-size:12px}
    .pill{
      font-size:12px; color:var(--muted);
      border:1px solid var(--line);
      padding:6px 10px; border-radius:999px;
      white-space:nowrap;
    }
    .iconbtn{
      border:1px solid var(--line);
      background:transparent;
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
    }
    .iconbtn:disabled{opacity:.55;cursor:not-allowed}

    .screen{padding:16px 16px 92px}
    @media (min-width:900px){ .screen{padding:18px 18px 98px} }

    .title{font-size:22px; margin:6px 0 6px; text-align:center}
    .sub{color:var(--muted); font-size:13px; margin:0 0 14px; text-align:center}

    .grid{display:grid; grid-template-columns:1fr; gap:12px}
    @media (min-width:900px){ .grid.two{grid-template-columns:1fr 1fr} }

    .card{
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      background:transparent;
    }
    .card h3{margin:0 0 10px;font-size:14px}
    .muted{color:var(--muted); font-size:13px}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input, textarea, select{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:1px solid var(--line);
      outline:none;
      font-size:15px;
      background:transparent;
      color:var(--text);
    }
    input:focus, textarea:focus, select:focus{
      border-color:rgba(78,108,255,.55);
      box-shadow:0 0 0 3px rgba(78,108,255,.18);
    }

    .btn{
      width:100%;
      border:none;
      border-radius:14px;
      padding:12px 14px;
      background:var(--pri);
      color:#fff;
      font-weight:900;
      cursor:pointer;
      margin-top:10px;
    }
    .btn.secondary{
      background:transparent;
      color:var(--text);
      border:1px solid var(--line);
      font-weight:900;
    }
    .btn.danger{background:var(--bad)}
    .btn.ok{background:var(--ok)}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .hidden{display:none !important}

    .nav{
      position:absolute; left:0; right:0; bottom:0;
      border-top:1px solid var(--line);
      padding:10px;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:8px;
      background:linear-gradient(180deg, transparent, rgba(0,0,0,.02));
    }
    .navbtn{
      border:1px solid var(--line);
      background:transparent;
      color:var(--muted);
      border-radius:14px;
      padding:10px 8px;
      cursor:pointer;
      display:flex;flex-direction:column;align-items:center;gap:6px;
      font-size:11px;
    }
    .navbtn span{font-size:18px;line-height:1}
    .navbtn.active{
      color:var(--text);
      border-color:rgba(78,108,255,.45);
      background:rgba(78,108,255,.10);
    }
    .navbtn:disabled{opacity:.55;cursor:not-allowed}

    .kpis{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }
    @media (min-width:900px){ .kpis{grid-template-columns:repeat(3,1fr)} }
    .kpi{
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
    }
    .kpi b{font-size:20px}
    .kpi small{display:block;color:var(--muted);margin-top:4px}

    .list{margin-top:10px}
    .item{
      border-top:1px solid var(--line);
      padding:10px 0;
      display:flex;justify-content:space-between;gap:10px;align-items:flex-start;
    }
    .item:first-child{border-top:none;padding-top:0}
    .tag{
      font-size:12px;border:1px solid var(--line);
      padding:6px 10px;border-radius:999px;color:var(--muted);
      white-space:nowrap;
    }

    /* Purchases cards */
    .pgrid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:10px}
    @media (min-width:900px){ .pgrid{grid-template-columns:1fr 1fr} }
    .pcard{
      border:1px solid var(--line);
      border-radius:18px;
      overflow:hidden;
      display:flex;
      background:rgba(0,0,0,.01);
    }
    body.dark .pcard{background:rgba(255,255,255,.02)}
    .pimg{
      width:116px; min-width:116px;
      background:linear-gradient(135deg, rgba(78,108,255,.35), rgba(111,193,255,.25));
      border-right:1px solid var(--line);
      display:flex;align-items:center;justify-content:center;
      font-size:26px;
    }
    .pimg img{width:100%;height:100%;object-fit:cover;display:block}
    .pbody{padding:12px;flex:1}
    .ptitle{font-weight:950;line-height:1.15}
    .prow{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{
      font-size:12px;border:1px solid var(--line);
      padding:6px 10px;border-radius:999px;color:var(--muted);
    }
    .actions{display:flex;gap:10px;margin-top:10px}
    .actions .btn{margin-top:0}
    .actions .btn.secondary{flex:1}
    .actions .btn.primary{flex:1}

    .bankGrid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (min-width:900px){ .bankGrid{grid-template-columns:repeat(3,1fr)} }
    .bankCard{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      cursor:pointer;
      user-select:none;
      display:flex; gap:10px; align-items:center;
      transition:transform .08s ease, background .08s ease, border-color .08s ease;
    }
    .bankCard:active{ transform:scale(.99) }
    .bankCard.active{
      border-color:rgba(78,108,255,.55);
      background:rgba(78,108,255,.10);
    }
    .bankIcon{
      width:34px;height:34px;border-radius:12px;
      border:1px solid var(--line);
      display:flex;align-items:center;justify-content:center;
      font-size:18px;
    }
    .bankName{font-weight:900; font-size:13px}
    .bankHint{color:var(--muted); font-size:12px; margin-top:2px}

    /* overlays */
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:flex; align-items:flex-start; justify-content:center;
      padding:18px;
      z-index: 9998;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .modal{
      width:min(640px,100%);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--sh);
      overflow:hidden;
      max-height: 92vh;
      display:flex;
      flex-direction:column;
      position:relative;
    }
    .modal header{border-bottom:1px solid var(--line); flex:0 0 auto}
    .modal > .screen{
      flex:1 1 auto;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom:16px !important;
    }

    /* Visible scrollbar for desktop */
    .modal > .screen::-webkit-scrollbar{ width: 8px; }
    .modal > .screen::-webkit-scrollbar-thumb{
      background: rgba(100,116,139,.45);
      border-radius: 999px;
    }
    body.dark .modal > .screen::-webkit-scrollbar-thumb{ background: rgba(148,163,184,.45); }

    /* Always-visible scroll indicator (–ø–∞–ª–æ—á–∫–∞) */
    .vscroll{
      position:absolute;
      right:10px;
      top:66px;
      bottom:12px;
      width:6px;
      border-radius:999px;
      background: rgba(100,116,139,.16);
      pointer-events:none;
      opacity: 0;
      transition: opacity .12s ease;
      z-index:2;
    }
    .vscroll .thumb{
      width:100%;
      min-height:26px;
      border-radius:999px;
      background: rgba(78,108,255,.70);
      transform: translateY(0);
    }
    body.dark .vscroll{ background: rgba(148,163,184,.14); }
    body.dark .vscroll .thumb{ background: rgba(91,124,250,.75); }

    .close{
      cursor:pointer;
      border:1px solid var(--line);
      background:transparent;
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
    }

    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:var(--toast); color:#fff;
      padding:10px 12px; border-radius:14px;
      font-size:13px; box-shadow:0 16px 40px rgba(0,0,0,.35);
      max-width:min(720px,92%);
      z-index: 9999;
    }
    body.dark .toast{color:var(--text)}
    .fineprint{color:var(--muted); font-size:12px; line-height:1.35}
  </style>
</head>
<body>
<div class="app">
  <div class="panel">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div class="titles">
          <b>MikPay 2.0</b>
          <small>–¶–µ–Ω—Ç—Ä –ø–æ–∫—É–ø–æ–∫ –∏ –æ–ø–ª–∞—Ç</small>
        </div>
        <span class="pill" id="rolePill">–ì–æ—Å—Ç—å</span>
      </div>
      <button class="iconbtn" id="gearBtn" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
    </header>

    <!-- AUTH -->
    <div class="screen" id="authScreen">
      <div class="title">–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
      <p class="sub">–ê–∫–∫–∞—É–Ω—Ç –∏ –ø–æ–∫—É–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ. –î–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ ‚Äî –≠–∫—Å–ø–æ—Ä—Ç/–ò–º–ø–æ—Ä—Ç –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.</p>

      <div class="grid two">
        <div class="card">
          <h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
          <label>Email</label>
          <input id="regEmail" type="email" placeholder="example@mail.com" autocomplete="email"/>
          <label>–ü–∞—Ä–æ–ª—å</label>
          <input id="regPass" type="password" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å" autocomplete="new-password"/>
          <button class="btn" id="regBtn">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        </div>

        <div class="card">
          <h3>–í—Ö–æ–¥</h3>
          <label>Email</label>
          <input id="loginEmail" type="email" placeholder="example@mail.com" autocomplete="username"/>
          <label>–ü–∞—Ä–æ–ª—å</label>
          <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"/>
          <button class="btn" id="loginBtn">–í–æ–π—Ç–∏</button>
          <button class="btn secondary" id="forgotBtn">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</button>
        </div>
      </div>
    </div>

    <!-- APP -->
    <div class="screen hidden" id="appScreen">

      <!-- DASH -->
      <div id="dashView">
        <div class="kpis">
          <div class="kpi">
            <b id="kpiSpent">0 ‚ÇΩ</b>
            <small>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ (–æ–ø–ª–∞—á–µ–Ω–æ)</small>
          </div>
          <div class="kpi">
            <b id="kpiPending">0</b>
            <small>–û–∂–∏–¥–∞—é—Ç –æ–ø–ª–∞—Ç—ã</small>
          </div>
          <div class="kpi">
            <b id="kpiTotal">0</b>
            <small>–í—Å–µ–≥–æ –ø–æ–∫—É–ø–æ–∫</small>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>–ë—ã—Å—Ç—Ä–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∫—É–ø–∫—É</h3>
          <div class="muted">–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É, —Å—É–º–º—É –∏ (–µ—Å–ª–∏ –ø–æ–ª—É—á–∏—Ç—Å—è) –º—ã –ø–æ–¥—Ç—è–Ω–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ/–∫–∞—Ä—Ç–∏–Ω–∫—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>

          <label>–°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä / –∑–∞–∫–∞–∑</label>
          <input id="quickLink" type="url" placeholder="https://..."/>

          <div class="grid two">
            <div>
              <label>–°—É–º–º–∞ (‚ÇΩ)</label>
              <input id="quickAmount" type="number" inputmode="numeric" placeholder="2990"/>
            </div>
            <div>
              <label>–ù–∞–∑–≤–∞–Ω–∏–µ (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º)</label>
              <input id="quickTitle" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –£–¥–æ—á–∫–∞ / –ó–∞–∫–∞–∑ #123"/>
            </div>
          </div>

          <button class="btn secondary" id="autoFillBtn">–ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ —Å—Å—ã–ª–∫–µ</button>
          <button class="btn" id="addPurchaseBtn">–î–æ–±–∞–≤–∏—Ç—å –≤ –ø–æ–∫—É–ø–∫–∏</button>
          <div class="fineprint" style="margin-top:10px">
            MikPay –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã –∏ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–ª–∞—Ç–µ–∂–∏. –ü—Ä–∏ –æ–ø–ª–∞—Ç–µ –º—ã –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –∑–∞—Å—Ç–∞–≤–∫—É/–∫–Ω–æ–ø–∫—É –Ω–∞ —Å–∞–π—Ç –±–∞–Ω–∫–∞/—Å–µ—Ä–≤–∏—Å–∞ (–ø–æ –≤–∞—à–∏–º —Å—Å—ã–ª–∫–∞–º –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö), –∞ –≤ MikPay —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –∏—Å—Ç–æ—Ä–∏—è.
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
          <div class="list" id="recentOps"><div class="muted">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div></div>
        </div>
      </div>

      <!-- PURCHASES -->
      <div class="hidden" id="purchasesView">
        <div class="card">
          <h3>–ü–æ–∫—É–ø–∫–∏</h3>
          <div class="muted">–ù–∞–∂–º–∏—Ç–µ ¬´–û–ø–ª–∞—Ç–∏—Ç—å¬ª ‚Üí –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –æ–∫–Ω–æ —Å –¥–µ—Ç–∞–ª—è–º–∏ –∏ –≤—ã–±–æ—Ä–æ–º –±–∞–Ω–∫–∞ ‚Üí –¥–∞–ª–µ–µ ¬´–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ¬ª.</div>
        </div>
        <div class="pgrid" id="purchasesGrid" aria-live="polite"></div>
      </div>

      <!-- HISTORY -->
      <div class="hidden" id="historyView">
        <div class="card">
          <h3>–ò—Å—Ç–æ—Ä–∏—è</h3>
          <div class="list" id="historyList"><div class="muted">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div></div>
        </div>
      </div>

      <!-- PROFILE -->
      <div class="hidden" id="profileView">
        <div class="card">
          <h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>
          <div class="list">
            <div class="item">
              <div><b>Email</b><div class="muted" id="profEmail">‚Äî</div></div>
              <span class="tag">–∞–∫–∫–∞—É–Ω—Ç</span>
            </div>
            <div class="item">
              <div><b>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</b><div class="muted">wwwwliii@outlook.com</div></div>
              <span class="tag">email</span>
            </div>
          </div>
        </div>
      </div>

      <!-- NAV -->
      <div class="nav">
        <button class="navbtn active" id="navDash"><span>‚ú®</span>–ì–ª–∞–≤–Ω–∞—è</button>
        <button class="navbtn" id="navPurch"><span>üßæ</span>–ü–æ–∫—É–ø–∫–∏</button>
        <button class="navbtn" id="navHist"><span>üïò</span>–ò—Å—Ç–æ—Ä–∏—è</button>
        <button class="navbtn" id="navProf"><span>üë§</span>–ü—Ä–æ—Ñ–∏–ª—å</button>
      </div>

    </div>
  </div>
</div>

<!-- SETTINGS -->
<div class="overlay hidden" id="settingsOv">
  <div class="modal" onclick="event.stopPropagation()">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div class="titles"><b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</b><small id="settingsEmail">‚Äî</small></div>
      </div>
      <button class="close" id="settingsCloseBtn">‚úï</button>
    </header>
    <div class="screen">
      <div class="card">
        <h3>–í–Ω–µ—à–Ω–∏–π –≤–∏–¥</h3>
        <button class="btn secondary" id="themeBtn">–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É</button>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>–°—Å—ã–ª–∫–∏ –¥–ª—è –æ–ø–ª–∞—Ç—ã (–≤–∞—à–∏)</h3>
        <div class="muted">–ß—Ç–æ–±—ã –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –±–∞–Ω–∫–∞ –æ—Ç–∫—Ä—ã–≤–∞–ª–∞—Å—å <b>–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è</b> —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–ø–ª–∞—Ç—ã, –≤—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ —Å–≤–æ–∏ –≥–æ—Ç–æ–≤—ã–µ —Å—Å—ã–ª–∫–∏ (invoice/checkout). –ï—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –æ—Ç–∫—Ä–æ–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Ç–æ–≤–∞—Ä/–∑–∞–∫–∞–∑.</div>

        <label>–°–±–µ—Ä ‚Äî checkout/invoice —Å—Å—ã–ª–∫–∞</label>
        <input id="link_sber" type="url" placeholder="https://..."/>

        <label>–¢-–ë–∞–Ω–∫ ‚Äî checkout/invoice —Å—Å—ã–ª–∫–∞</label>
        <input id="link_tbank" type="url" placeholder="https://..."/>

        <label>–ÆMoney ‚Äî checkout/invoice —Å—Å—ã–ª–∫–∞</label>
        <input id="link_yoom" type="url" placeholder="https://..."/>

        <label>–í–¢–ë ‚Äî checkout/invoice —Å—Å—ã–ª–∫–∞</label>
        <input id="link_vtb" type="url" placeholder="https://..."/>

        <label>–û–∑–æ–Ω –ë–∞–Ω–∫ ‚Äî checkout/invoice —Å—Å—ã–ª–∫–∞</label>
        <input id="link_ozon" type="url" placeholder="https://..."/>

        <button class="btn secondary" id="linksSaveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>–ü–µ—Ä–µ–Ω–æ—Å –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏</h3>
        <button class="btn secondary" id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç</button>
        <button class="btn secondary" id="importBtn">–ò–º–ø–æ—Ä—Ç</button>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>–î–∞–Ω–Ω—ã–µ</h3>
        <button class="btn secondary" id="resetAllBtn">–°–±—Ä–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
      </div>

      <button class="btn danger" id="logoutBtn">–í—ã–π—Ç–∏</button>
    </div>
    <div class="vscroll"><div class="thumb"></div></div>
  </div>
</div>

<!-- FORGOT PASS -->
<div class="overlay hidden" id="forgotOv">
  <div class="modal" onclick="event.stopPropagation()">
    <header>
      <div class="brand"><div class="logo"></div><div class="titles"><b>–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è</b><small>–≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ</small></div></div>
      <button class="close" id="forgotCloseBtn">‚úï</button>
    </header>
    <div class="screen">
      <label>Email</label>
      <input id="forgotEmail" type="email" placeholder="example@mail.com"/>
      <label>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
      <input id="forgotNew" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
      <button class="btn" id="resetPassBtn">–°–±—Ä–æ—Å–∏—Ç—å</button>
    </div>
    <div class="vscroll"><div class="thumb"></div></div>
  </div>
</div>

<!-- PAY MODAL (Step 2) -->
<div class="overlay hidden" id="payOv">
  <div class="modal" onclick="event.stopPropagation()">
    <header>
      <div class="brand"><div class="logo"></div><div class="titles"><b>–û–ø–ª–∞—Ç–∞</b><small id="paySub">‚Äî</small></div></div>
      <button class="close" id="payCloseBtn">‚úï</button>
    </header>
    <div class="screen">
      <div class="card">
        <div class="muted">–®–∞–≥ 2: –≤—ã–±–µ—Ä–∏—Ç–µ –±–∞–Ω–∫/—Å–µ—Ä–≤–∏—Å –∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –∫ –æ–ø–ª–∞—Ç–µ. MikPay –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã ‚Äî –≤—ã –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç–µ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –±–∞–Ω–∫–∞/—Å–µ—Ä–≤–∏—Å–∞.</div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>–î–µ—Ç–∞–ª–∏ –ø–æ–∫—É–ø–∫–∏</h3>
        <div class="pcard" style="margin-top:8px">
          <div class="pimg" id="payImgBox">üõçÔ∏è</div>
          <div class="pbody">
            <div class="ptitle" id="payTitle">‚Äî</div>
            <div class="prow">
              <span class="chip" id="payAmount">‚Äî</span>
              <span class="chip" id="payStatus">–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã</span>
            </div>
            <div class="fineprint" style="margin-top:8px;word-break:break-all" id="payLink">‚Äî</div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–ª–∞—Ç—É</h3>
        <div class="bankGrid" id="bankGridPay"></div>
        <button class="btn" id="openPaymentBtn">–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ</button>
        <button class="btn ok" id="confirmPaidBtn" disabled>–Ø –æ–ø–ª–∞—Ç–∏–ª ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        <button class="btn secondary" id="markPlannedBtn">–ü–æ–∫–∞ –Ω–µ –æ–ø–ª–∞—á–∏–≤–∞—Ç—å</button>
        <div class="fineprint" style="margin-top:10px">
          –ï—Å–ª–∏ —É –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –±–∞–Ω–∫–∞ –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∑–∞–¥–∞–Ω–∞ checkout-—Å—Å—ã–ª–∫–∞ ‚Äî –æ—Ç–∫—Ä–æ–µ–º –µ—ë. –ò–Ω–∞—á–µ –æ—Ç–∫—Ä–æ–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Ç–æ–≤–∞—Ä/–∑–∞–∫–∞–∑.
        </div>
      </div>
    </div>
    <div class="vscroll"><div class="thumb"></div></div>
  </div>
</div>

<input id="importFile" type="file" accept="application/json" class="hidden"/>
<div class="toast hidden" id="toast"></div>

<script>
(() => {
  "use strict";

  // Storage keys
  const K_USERS   = "mikpay2_users";
  const K_SESSION = "mikpay2_session";
  const K_THEME   = "mikpay2_theme";
  const K_LINKS   = "mikpay2_links";

  // Banks (unified entry)
  const BANKS = [
    { id:"sber",  name:"–°–±–µ—Ä",     hint:"sberbank.ru",  icon:"üü¢", url:"https://www.sberbank.ru/" },
    { id:"tbank", name:"–¢-–ë–∞–Ω–∫",   hint:"tbank.ru",     icon:"üü°", url:"https://www.tbank.ru/" },
    { id:"yoom",  name:"–ÆMoney",   hint:"yoomoney.ru",  icon:"üîµ", url:"https://yoomoney.ru/" },
    { id:"vtb",   name:"–í–¢–ë",      hint:"vtb.ru",       icon:"üî∑", url:"https://www.vtb.ru/" },
    { id:"ozon",  name:"–û–∑–æ–Ω –ë–∞–Ω–∫",hint:"finance.ozon", icon:"üü£", url:"https://finance.ozon.ru/" }
  ];

  // helpers
  const el = (id) => document.getElementById(id);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));
  const safeJSON = (val, fallback) => { try { return JSON.parse(val ?? ""); } catch { return fallback; } };

  const loadUsers   = () => safeJSON(localStorage.getItem(K_USERS), {}) || {};
  const saveUsers   = (u) => localStorage.setItem(K_USERS, JSON.stringify(u));
  const loadSession = () => safeJSON(localStorage.getItem(K_SESSION), null);
  const saveSession = (s) => localStorage.setItem(K_SESSION, JSON.stringify(s));
  const loadLinks   = () => safeJSON(localStorage.getItem(K_LINKS), {}) || {};
  const saveLinks   = (o) => localStorage.setItem(K_LINKS, JSON.stringify(o || {}));

  const money = (n) => Math.max(0, Math.floor(Number(n) || 0)).toLocaleString("ru-RU") + " ‚ÇΩ";
  const nowStr = () => new Date().toLocaleString("ru-RU");
  const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);

  const toast = (msg) => {
    const t = el("toast");
    t.textContent = msg;
    t.classList.remove("hidden");
    setTimeout(() => t.classList.add("hidden"), 1600);
  };

  const closeOv = (id) => el(id).classList.add("hidden");
  const openOv  = (id) => el(id).classList.remove("hidden");
  $$(".overlay").forEach(ov => ov.addEventListener("click", () => ov.classList.add("hidden")));
  $$(".modal").forEach(m => m.addEventListener("click", (e) => e.stopPropagation()));
  document.addEventListener("keydown", (e) => { if (e.key === "Escape") $$(".overlay").forEach(o => o.classList.add("hidden")); });

  // Scroll indicator ("–ø–∞–ª–æ—á–∫–∞") for any modal
  (function initVScroll(){
    const modals = Array.from(document.querySelectorAll('.overlay .modal'));
    const ensureBar = (modal) => modal.querySelector('.vscroll');
    const attach = (modal) => {
      const scr = modal.querySelector(':scope > .screen');
      const bar = ensureBar(modal);
      if(!scr || !bar) return;
      const thumb = bar.querySelector('.thumb');
      const update = () => {
        const ch = scr.clientHeight, sh = scr.scrollHeight;
        if(sh <= ch + 1){ bar.style.opacity = '0'; return; }
        bar.style.opacity = '1';
        const track = bar.clientHeight;
        const th = Math.max(26, Math.round(track * (ch / sh)));
        thumb.style.height = th + 'px';
        const maxScroll = sh - ch;
        const maxMove = track - th;
        const y = maxScroll ? (scr.scrollTop / maxScroll) * maxMove : 0;
        thumb.style.transform = 'translateY(' + y + 'px)';
      };
      scr.addEventListener('scroll', update, {passive:true});
      window.addEventListener('resize', update);
      const tick = () => setTimeout(update, 0);
      tick();
      const mo = new MutationObserver(tick);
      mo.observe(modal.closest('.overlay'), {attributes:true, attributeFilter:['class']});
    };
    modals.forEach(attach);
  })();

  // Theme
  if (localStorage.getItem(K_THEME) === "dark") document.body.classList.add("dark");
  el("themeBtn").onclick = () => {
    document.body.classList.toggle("dark");
    localStorage.setItem(K_THEME, document.body.classList.contains("dark") ? "dark" : "light");
    toast("–¢–µ–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∞");
  };

  // Navigation
  const views = { dash: el("dashView"), purch: el("purchasesView"), hist: el("historyView"), prof: el("profileView") };
  const navBtns = { dash: el("navDash"), purch: el("navPurch"), hist: el("navHist"), prof: el("navProf") };
  const navTo = (key) => {
    Object.keys(views).forEach(k => views[k].classList.toggle("hidden", k !== key));
    Object.keys(navBtns).forEach(k => navBtns[k].classList.toggle("active", k === key));
  };

  // User
  const current = () => {
    const s = loadSession();
    if (!s || !s.email) return null;
    const users = loadUsers();
    if (!users[s.email]) return null;
    return { email: s.email, u: users[s.email] };
  };

  const ensureUserShape = (u) => {
    u.purchases = u.purchases || [];
    u.ops = u.ops || [];
    return u;
  };

  const addOp = (type, title, amount) => {
    const c = current(); if (!c) return;
    const users = loadUsers();
    ensureUserShape(users[c.email]);
    users[c.email].ops.unshift({ type, title, amount: Math.floor(Number(amount)||0), when: nowStr() });
    saveUsers(users);
  };

  // Render
  const renderKPIs = () => {
    const c = current(); if(!c) return;
    ensureUserShape(c.u);
    const paid = c.u.purchases.filter(p => p.status === "paid");
    const pending = c.u.purchases.filter(p => p.status !== "paid");
    const spent = paid.reduce((s,p)=>s + (p.amount||0), 0);
    el("kpiSpent").textContent = money(spent);
    el("kpiPending").textContent = String(pending.length);
    el("kpiTotal").textContent = String(c.u.purchases.length);
  };

  const renderRecentOps = () => {
    const c = current(); if(!c) return;
    ensureUserShape(c.u);
    const list = el("recentOps");
    const ops = c.u.ops.slice(0,6);
    list.innerHTML = !ops.length ? '<div class="muted">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>' :
      ops.map(o => `
        <div class="item">
          <div><b>${o.title}</b><div class="muted">${o.when}</div></div>
          <span class="tag">${o.amount ? money(o.amount) : "‚Äî"}</span>
        </div>`).join("");
  };

  const renderHistory = () => {
    const c = current(); if(!c) return;
    ensureUserShape(c.u);
    const list = el("historyList");
    const ops = c.u.ops;
    list.innerHTML = !ops.length ? '<div class="muted">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>' :
      ops.slice(0,40).map(o => `
        <div class="item">
          <div><b>${o.title}</b><div class="muted">${o.when}</div></div>
          <span class="tag">${o.amount ? money(o.amount) : "‚Äî"}</span>
        </div>`).join("");
  };

  const renderPurchases = () => {
    const c = current(); if(!c) return;
    ensureUserShape(c.u);
    const grid = el("purchasesGrid");
    const items = c.u.purchases.slice().sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
    if(!items.length){
      grid.innerHTML = '<div class="card"><div class="muted">–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ–∫—É–ø–æ–∫. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ.</div></div>';
      return;
    }
    grid.innerHTML = items.map(p => {
      const statusChip = p.status === "paid" ? "–û–ø–ª–∞—á–µ–Ω–æ" : "–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã";
      const when = p.status === "paid" ? (p.paidWhen || "‚Äî") : (p.createdWhen || "‚Äî");
      const icon = p.status === "paid" ? "‚úÖ" : "üõçÔ∏è";
      const img = p.image ? `<img alt="" src="${p.image}"/>` : icon;
      return `
        <div class="pcard">
          <div class="pimg">${img}</div>
          <div class="pbody">
            <div class="ptitle">${escapeHtml(p.title || "–ü–æ–∫—É–ø–∫–∞")}</div>
            <div class="muted" style="margin-top:6px;word-break:break-all">${escapeHtml(p.link || "")}</div>
            <div class="prow">
              <span class="chip">${money(p.amount||0)}</span>
              <span class="chip">${statusChip}</span>
              <span class="chip">${when}</span>
            </div>
            <div class="actions">
              <button class="btn secondary" data-act="copy" data-id="${p.id}">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
              <button class="btn primary" data-act="pay" data-id="${p.id}">${p.status==="paid" ? "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å" : "–û–ø–ª–∞—Ç–∏—Ç—å"}</button>
            </div>
          </div>
        </div>
      `;
    }).join("");
  };

  const renderAll = () => {
    const c = current(); if(!c) return;
    el("rolePill").textContent = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
    el("profEmail").textContent = c.email;
    renderKPIs();
    renderRecentOps();
    renderPurchases();
    renderHistory();
  };

  // Simple escape
  function escapeHtml(str){
    return String(str ?? "").replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  // Auth show/hide
  const showAuth = () => {
    el("authScreen").classList.remove("hidden");
    el("appScreen").classList.add("hidden");
    el("rolePill").textContent = "–ì–æ—Å—Ç—å";
    el("gearBtn").disabled = true;
    $$(".navbtn").forEach(b => b.disabled = true);
  };
  const showApp = () => {
    el("authScreen").classList.add("hidden");
    el("appScreen").classList.remove("hidden");
    el("gearBtn").disabled = false;
    $$(".navbtn").forEach(b => b.disabled = false);
    navTo("dash");
    renderAll();
  };

  // Register/Login
  el("regBtn").onclick = () => {
    const email = el("regEmail").value.trim().toLowerCase();
    const pass  = el("regPass").value;
    if (!email || !pass) return toast("–ó–∞–ø–æ–ª–Ω–∏ email –∏ –ø–∞—Ä–æ–ª—å");
    const users = loadUsers();
    if (users[email]) return toast("–ê–∫–∫–∞—É–Ω—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç");
    users[email] = ensureUserShape({ pass, purchases:[], ops:[] });
    saveUsers(users);
    toast("–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω");
    el("loginEmail").value = email;
    el("loginPass").value = pass;
  };

  el("loginBtn").onclick = () => {
    const email = el("loginEmail").value.trim().toLowerCase();
    const pass  = el("loginPass").value;
    const users = loadUsers();
    if (!users[email] || users[email].pass !== pass) return toast("–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å");
    saveSession({ email });
    toast("–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω");
    showApp();
  };

  // Forgot
  el("forgotBtn").onclick = () => openOv("forgotOv");
  el("forgotCloseBtn").onclick = () => closeOv("forgotOv");
  el("resetPassBtn").onclick = () => {
    const email = (el("forgotEmail").value||"").trim().toLowerCase();
    const np = el("forgotNew").value;
    if (!email || !np) return toast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è");
    const users = loadUsers();
    if (!users[email]) return toast("–ê–∫–∫–∞—É–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ");
    users[email].pass = np;
    saveUsers(users);
    toast("–ü–∞—Ä–æ–ª—å —Å–±—Ä–æ—à–µ–Ω");
    closeOv("forgotOv");
    el("loginEmail").value = email;
    el("loginPass").value = np;
  };

  // Settings
  el("gearBtn").onclick = () => {
    const c = current(); if(!c) return toast("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ");
    el("settingsEmail").textContent = c.email;
    fillLinksUI();
    openOv("settingsOv");
  };
  el("settingsCloseBtn").onclick = () => closeOv("settingsOv");

  const fillLinksUI = () => {
    const links = loadLinks();
    ["sber","tbank","yoom","vtb","ozon"].forEach(id => {
      const inp = el("link_"+id);
      if(inp) inp.value = links[id] || "";
    });
  };
  el("linksSaveBtn").onclick = () => {
    const obj = {};
    ["sber","tbank","yoom","vtb","ozon"].forEach(id => {
      const v = (el("link_"+id)?.value||"").trim();
      if(v) obj[id] = v;
    });
    saveLinks(obj);
    toast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
  };

  // Export/Import/Reset/Logout
  el("exportBtn").onclick = () => {
    const payload = {
      users: loadUsers(),
      session: loadSession(),
      theme: localStorage.getItem(K_THEME)||"light",
      links: loadLinks(),
      exportedAt: new Date().toISOString()
    };
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href=url; a.download="mikpay2_export.json";
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    toast("–≠–∫—Å–ø–æ—Ä—Ç –≥–æ—Ç–æ–≤");
  };
  el("importBtn").onclick = () => { const inp = el("importFile"); inp.value=""; inp.click(); };
  el("importFile").onchange = () => {
    const file = el("importFile").files?.[0]; if(!file) return;
    const r = new FileReader();
    r.onload = () => {
      try{
        const data = JSON.parse(String(r.result||""));
        if(!data || typeof data !== "object" || !data.users) return toast("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–∞–π–ª");
        if(!confirm("–ò–º–ø–æ—Ä—Ç –∑–∞–º–µ–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?")) return;
        localStorage.setItem(K_USERS, JSON.stringify(data.users||{}));
        localStorage.setItem(K_SESSION, JSON.stringify(data.session||null));
        localStorage.setItem(K_THEME, data.theme==="dark" ? "dark" : "light");
        localStorage.setItem(K_LINKS, JSON.stringify(data.links||{}));
        toast("–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω");
        setTimeout(()=>location.reload(), 400);
      }catch{ toast("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞"); }
    };
    r.readAsText(file);
  };

  el("resetAllBtn").onclick = () => {
    if(!confirm("–°–±—Ä–æ—Å–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç—ã/–ø–æ–∫—É–ø–∫–∏/–∏—Å—Ç–æ—Ä–∏—é –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ?")) return;
    localStorage.removeItem(K_USERS);
    localStorage.removeItem(K_SESSION);
    localStorage.removeItem(K_LINKS);
    closeOv("settingsOv");
    toast("–°–±—Ä–æ—à–µ–Ω–æ");
    showAuth();
  };

  el("logoutBtn").onclick = () => {
    saveSession(null);
    closeOv("settingsOv");
    toast("–í—ã –≤—ã—à–ª–∏");
    showAuth();
  };

  // Nav handlers
  navBtns.dash.onclick  = () => { navTo("dash"); renderKPIs(); renderRecentOps(); };
  navBtns.purch.onclick = () => { navTo("purch"); renderPurchases(); };
  navBtns.hist.onclick  = () => { navTo("hist"); renderHistory(); };
  navBtns.prof.onclick  = () => { navTo("prof"); };

  // --- Purchase add ---
  const amt = (v) => Math.floor(Number(v||0));
  const normalizeUrl = (u) => {
    const s = String(u||"").trim();
    if(!s) return "";
    if(s.startsWith("http://") || s.startsWith("https://")) return s;
    return "https://" + s;
  };

  // Best-effort metadata fetch via public proxy (may fail on some sites)
  const fetchMeta = async (url) => {
    const u = normalizeUrl(url);
    // Try a couple of proxies; if blocked ‚Äî we fail gracefully
    const proxies = [
      (x) => "https://r.jina.ai/" + x,
      (x) => "https://r.jina.ai/http://"+ x.replace(/^https?:\/\//,""),
      (x) => "https://r.jina.ai/https://"+ x.replace(/^https?:\/\//,"")
    ];
    let text = "";
    for(const p of proxies){
      try{
        const res = await fetch(p(u), {cache:"no-store"});
        if(!res.ok) continue;
        text = await res.text();
        if(text && text.length > 200) break;
      }catch{}
    }
    if(!text) throw new Error("fetch failed");

    // Try parse title and og:image from returned content (might be raw or transformed)
    const titleMatch = text.match(/<title[^>]*>([^<]{2,200})<\/title>/i) || text.match(/^\s*#\s+(.{2,120})/m);
    let title = titleMatch ? String(titleMatch[1]).trim() : "";
    // og:image
    const imgMatch = text.match(/property=["']og:image["'][^>]*content=["']([^"']+)["']/i) ||
                     text.match(/content=["']([^"']+)["'][^>]*property=["']og:image["']/i) ||
                     text.match(/https?:\/\/[^ 
"']+\.(?:jpg|jpeg|png|webp)/i);
    let image = imgMatch ? String(imgMatch[1]).trim() : "";
    // clean entities a bit
    title = title.replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">");
    return { title, image };
  };

  el("autoFillBtn").onclick = async () => {
    const link = el("quickLink").value;
    const u = normalizeUrl(link);
    if(!u.startsWith("http")) return toast("–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É (https://...)");
    toast("–ü—Ä–æ–±—É—é –ø–æ–¥—Ç—è–Ω—É—Ç—å –¥–∞–Ω–Ω—ã–µ‚Ä¶");
    try{
      const meta = await fetchMeta(u);
      if(meta.title && !el("quickTitle").value.trim()) el("quickTitle").value = meta.title.slice(0,120);
      // we don't set image here, image stored on add (best effort via meta fetch again)
      toast("–ì–æ—Ç–æ–≤–æ");
    }catch{
      toast("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Ç—è–Ω—É—Ç—å ‚Äî –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Ä—É—á–Ω—É—é");
    }
  };

  const createPurchase = async ({link, title, amount}) => {
    const c = current(); if(!c) return;
    const users = loadUsers();
    ensureUserShape(users[c.email]);

    const u = normalizeUrl(link);
    let t = (title||"").trim();
    let img = "";
    try{
      const meta = await fetchMeta(u);
      if(!t && meta.title) t = meta.title.slice(0,120);
      if(meta.image && meta.image.startsWith("http")) img = meta.image;
    }catch{}
    if(!t) t = "–ü–æ–∫—É–ø–∫–∞";

    const p = {
      id: uid(),
      link: u,
      title: t,
      amount: Math.max(0, Math.floor(Number(amount)||0)),
      image: img,
      status: "pending",
      createdAt: Date.now(),
      createdWhen: nowStr(),
      paidAt: null,
      paidWhen: null,
      paidBy: null
    };

    users[c.email].purchases.unshift(p);
    addOp("create", `–î–æ–±–∞–≤–ª–µ–Ω–æ: ${t}`, p.amount);
    saveUsers(users);
    renderAll();
  };

  el("addPurchaseBtn").onclick = async () => {
    const link = el("quickLink").value;
    const amount = amt(el("quickAmount").value);
    const title = el("quickTitle").value;
    if(!normalizeUrl(link).startsWith("http")) return toast("–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É (https://...)");
    if(!Number.isFinite(amount) || amount <= 0) return toast("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É");
    await createPurchase({link, title, amount});
    el("quickLink").value = "";
    el("quickAmount").value = "";
    el("quickTitle").value = "";
    toast("–î–æ–±–∞–≤–ª–µ–Ω–æ");
  };

  // --- Pay flow (Step 2 modal) ---
  let activePurchaseId = null;
  const payState = { bank: BANKS[0].id };

  const makeBankSelector = (mountId, stateObj, key) => {
    const mount = el(mountId);
    mount.innerHTML = BANKS.map(b => `
      <div class="bankCard" data-bank="${b.id}">
        <div class="bankIcon">${b.icon}</div>
        <div>
          <div class="bankName">${b.name}</div>
          <div class="bankHint">${b.hint}</div>
        </div>
      </div>`).join("");

    const setActive = (id) => {
      stateObj[key] = id;
      $$("#" + mountId + " .bankCard").forEach(c => c.classList.toggle("active", c.dataset.bank === id));
    };

    mount.addEventListener("click", (e) => {
      const card = e.target.closest(".bankCard");
      if(card) setActive(card.dataset.bank);
    });

    setActive(BANKS[0].id);
  };

  makeBankSelector("bankGridPay", payState, "bank");

  const setPayImg = (src) => {
    const box = el("payImgBox");
    if(src && src.startsWith("http")){
      box.innerHTML = `<img alt="" src="${src}"/>`;
    }else{
      box.textContent = "üõçÔ∏è";
    }
  };

  const openPayModalFor = (purchaseId) => {
    const c = current(); if(!c) return;
    ensureUserShape(c.u);
    const p = c.u.purchases.find(x => x.id === purchaseId);
    if(!p) return;
    activePurchaseId = purchaseId;

    el("paySub").textContent = p.status === "paid" ? "—á–µ–∫ / –¥–µ—Ç–∞–ª–∏" : "—à–∞–≥ 2: –æ–ø–ª–∞—Ç–∞";
    el("payTitle").textContent = p.title;
    el("payAmount").textContent = money(p.amount);
    el("payStatus").textContent = (p.status === "paid") ? ("–û–ø–ª–∞—á–µ–Ω–æ ‚Ä¢ " + (p.paidWhen||"")) : "–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã";
    el("payLink").textContent = p.link;
    setPayImg(p.image);

    el("confirmPaidBtn").disabled = true;
    openOv("payOv");
  };

  el("payCloseBtn").onclick = () => closeOv("payOv");

  const openPayment = () => {
    const c = current(); if(!c) return toast("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ");
    ensureUserShape(c.u);
    const p = c.u.purchases.find(x => x.id === activePurchaseId);
    if(!p) return toast("–ü–æ–∫—É–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
    const links = loadLinks();
    const bankId = payState.bank;
    const bank = BANKS.find(b => b.id === bankId) || BANKS[0];
    const custom = (links && links[bankId]) ? String(links[bankId]).trim() : "";
    const target = (custom && custom.startsWith("http")) ? custom : p.link;

    const w = window.open(target, "_blank", "noopener,noreferrer");
    if(!w && confirm("–ë—Ä–∞—É–∑–µ—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –æ–∫–Ω–æ. –û—Ç–∫—Ä—ã—Ç—å –≤ —ç—Ç–æ–π –≤–∫–ª–∞–¥–∫–µ?")) location.href = target;
    el("confirmPaidBtn").disabled = false;
    toast("–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞–∂–º–∏—Ç–µ ¬´–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å¬ª");
  };

  const confirmPaid = () => {
    const c = current(); if(!c) return toast("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ");
    const users = loadUsers();
    const u = users[c.email]; if(!u) return;
    ensureUserShape(u);

    const idx = u.purchases.findIndex(x => x.id === activePurchaseId);
    if(idx === -1) return toast("–ü–æ–∫—É–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
    const p = u.purchases[idx];

    const bank = BANKS.find(b => b.id === payState.bank) || BANKS[0];
    p.status = "paid";
    p.paidAt = Date.now();
    p.paidWhen = nowStr();
    p.paidBy = bank.name;

    saveUsers(users);
    addOp("paid", `–û–ø–ª–∞—á–µ–Ω–æ (${bank.name}): ${p.title}`, p.amount);
    closeOv("payOv");
    toast("–ì–æ—Ç–æ–≤–æ");
    renderAll();
    navTo("hist");
  };

  const markPlanned = () => {
    const c = current(); if(!c) return;
    const users = loadUsers();
    const u = users[c.email]; if(!u) return;
    ensureUserShape(u);
    const p = u.purchases.find(x => x.id === activePurchaseId);
    if(!p) return;
    p.status = "pending";
    p.paidAt = null; p.paidWhen = null; p.paidBy = null;
    saveUsers(users);
    addOp("pending", `–û—Ç–ª–æ–∂–µ–Ω–æ: ${p.title}`, p.amount);
    toast("–û—Ç–ª–æ–∂–µ–Ω–æ");
    closeOv("payOv");
    renderAll();
  };

  el("openPaymentBtn").onclick = openPayment;
  el("confirmPaidBtn").onclick = confirmPaid;
  el("markPlannedBtn").onclick = markPlanned;

  // Purchases grid click handlers
  el("purchasesGrid").addEventListener("click", async (e) => {
    const btn = e.target.closest("button");
    if(!btn) return;
    const act = btn.dataset.act;
    const id = btn.dataset.id;
    const c = current(); if(!c) return;
    ensureUserShape(c.u);
    const p = c.u.purchases.find(x => x.id === id);
    if(!p) return;

    if(act === "copy"){
      try{ await navigator.clipboard.writeText(p.link); toast("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞"); }
      catch{ toast("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å"); }
    }
    if(act === "pay"){
      openPayModalFor(id);
    }
  });

  // Init
  el("gearBtn").disabled = true;
  $$(".navbtn").forEach(b => b.disabled = true);

  const s = loadSession();
  const users0 = loadUsers();
  if (s && s.email && users0[s.email]) showApp();
  else showAuth();
})();
</script>
</body>
</html>
